# TxManager与事务控制方的通讯协议


LCN通讯是基于TCP长连接的socket通讯，TxManager与事务控制方是基于netty框架完成的。该协议只描述参与Socket通讯的协议。

## 数据协议规则

数据接口都分为请求与响应。数据格式为json格式的数据。格式如下（心跳指令）：

请求：{"p":"{}","a":"h","k":"h"}

响应：{"d":"3","k":"h"}

请求指令分为了三个参数：p a k，分别代指：param action key，也就是参数、指令标示、唯一标示。

参数：请求需要传递的参数。  
指令标示：区分不同的协议。   
唯一标示：指令协议的唯一性标示，返回数据时要带着这个参数。   

响应指令分为两个参数：d k，分别代指：data，key，也就是数据域，唯一标示。

数据域：响应数据。   
唯一标示：指令协议的唯一性标示，返回请求时传递的数值。   


下面是详细的协议介绍：


### 心跳包

{"p":"{}","a":"h","k":"h"}

{"d":"3","k":"h"}

|  调用关系 | 事务控制方->TxManager |  
| --- | --- | 
| 指令标示 | h |
| 请求参数 | 无“{}”|
| 响应数据 | 数字"3" |

响应数据数字的含义：业务模块与TxManager之间通讯的最大等待时间




### 创建事务组

{"a":"cg","k":"TOT1buMh","p":{}}

{"d":"{\"st\":1504935628891,\"s\":0,\"nt\":1504935628905,\"g\":\"Y6wP4irB\",\"o\":0}","k":"TOT1buMh"}

|  调用关系 | 事务控制方->TxManager |  
| --- | --- | 
| 指令标示 | cg |
| 请求参数 | 无“{}”|
| 响应数据 | |
| st| 开始时间 |
| s| 事务状态 0 失败 1 成功 |
| nt| 当前时间 |
| g| 事务组ID |
| o| 是否结束 0 未结束 1 已结束 |


### 添加事务组

{"a":"atg","k":"bHcTk7bw","p":{"s":0,"t":"LGk7DYvV","u":"bcaf6c421335b3543a6ead169c0049cf","g":"vSqCF5oq"}}

{"d":"{\"st\":1504936357828,\"s\":0,\"nt\":1504936358367,\"g\":\"vSqCF5oq\",\"o\":0}","k":"bHcTk7bw"}

| 调用关系 | 事务控制方->TxManager |
| --- | --- |
| 指令标示 | atg |
| 请求参数 |  |
| s | 事务是事务组 0 否 1 是 |
| t | 唤醒TaskId |
| u | 模块唯一标示 |
| g | 事务组Id |
| 响应数据 |  |
| st | 开始时间 |
| s | 事务状态 0 失败 1 成功 |
| nt | 当前时间 |
| g | 事务组ID |
| o | 是否结束 0 未结束 1 已结束 |

### 关闭事务组

{"a":"ctg","k":"oQq276AM","p":{"s":1,"g":"vSqCF5oq"}}

{"p":{"d":"1"},"a":"t","k":"oQq276AM"}

| 调用关系 | 事务控制方->TxManager |
| --- | --- |
| 指令标示 | ctg |
| 请求参数 |  |
| s | 事务是否正常 0 否 1 是 |
| g | 事务组Id |
| 响应数据 |  |
| d | 是否正常通知执行 0 否 1 是 |

###  检查事务组

{"a":"ckg","k":"Ysf2u6I0","p":{"t":"LGk7DYvV","g":"vSqCF5oq"}}

{"p":{"d":"1"},"a":"t","k":"Ysf2u6I0"}

| 调用关系 | 事务控制方->TxManager |
| --- | --- |
| 指令标示 | ckg |
| 请求参数 |  |
| t | 事务TaskId |
| g | 事务组Id |
| 响应数据 |  |
| d | 事务状态 0 事务不存在 -1 事务尚未结束 1 事务尚未通知 |


###  通知事务单元


{"a":"t","c":1,"t":"LGk7DYvV","k":"Ysf2u6I0"}

{"p":{"d":"1"},"a":"t","k":"Ysf2u6I0"}


| 调用关系 | TxManager-> 事务控制方|
| --- | --- |
| 指令标示 | t |
| 请求参数 |  |
| c | 事务状态 1 提交 其他回归 |
| t | 事务TaskId |
| 响应数据 |  |
| d | 是否结束 0 未结束 1 已结束 |

该接口与其他的接口存在差异。请求时没有p而是c/t参数。这里c/t就相当于p下的c/t参数


###  TxManager检查控制方是否还保留着补偿数据


{"a":"c","g":"LGk7DYvV","k":"Ysf2u6I0"}

{"p":{"d":"1"},"a":"c","k":"Ysf2u6I0"}


| 调用关系 | TxManager-> 事务控制方|
| --- | --- |
| 指令标示 | c |
| 请求参数 |  |
| g | 事务组Id |
| 响应数据 |  |
| d | 是否存在 0 不存在 1 存在 |

该接口与其他的接口存在差异。请求时没有p而是g参数。这里g就相当于p下的g参数

